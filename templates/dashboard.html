<!DOCTYPE html>
<html>
<head>
  <title>Fleet Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h2>Fleet Dashboard</h2>
    <table class="table table-bordered" id="fleet-table">
      <thead>
        <tr>
          <th>Fleet ID</th>
          <th>Last Seen</th>
          <th>Speed</th>
        </tr>
      </thead>
      <tbody id="fleet-body"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="fleetModal" tabindex="-1" aria-labelledby="fleetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title" id="fleetModalLabel">Fleet Info</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="fleetModalBody">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadFleetData() {
      try {
        const res = await fetch('/location/latest/all');
        const data = await res.json();

        const tbody = document.getElementById('fleet-body');
        tbody.innerHTML = '';

        for (const entry of data) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><a href="#" onclick="showFleetModal('${entry.fleet_id}')">${entry.fleet_id}</a></td>
            <td>${entry.updated_at}</td>
            <td>${entry.speed}</td>
          `;
          tbody.appendChild(row);
        }
      } catch (err) {
        console.error('Error loading fleet data:', err);
      }
    }

    async function showFleetModal(fleet_id) {
      document.getElementById('fleetModalLabel').innerText = `Fleet ID: ${fleet_id}`;
      document.getElementById('fleetModalBody').innerHTML = `Loading...`;

      try {
        const [loc, recent, avg] = await Promise.all([
          fetch(`/location/latest/${fleet_id}`).then(res => res.json()),
          fetch(`/location/history/${fleet_id}`).then(res => res.json()),
          fetch(`/location/speed/average/${fleet_id}`).then(res => res.json()),
        ]);

        const recentList = (recent || []).map(loc => `(${loc.latitude}, ${loc.longitude})`).join('<br>') || 'No data';

        document.getElementById('fleetModalBody').innerHTML = `
          <p><strong>Current Location:</strong> (${loc.latitude}, ${loc.longitude})</p>
          <p><strong>Average Speed:</strong> ${avg.avg_speed ?? 'N/A'} km/h</p>
          <p><strong>Recent Locations (Last 10):</strong><br>${recentList}</p>
        `;
      } catch (err) {
        document.getElementById('fleetModalBody').innerHTML = `<p class="text-danger">Failed to load data.</p>`;
        console.error(err);
      }

      new bootstrap.Modal(document.getElementById('fleetModal')).show();
    }

    loadFleetData();
    setInterval(loadFleetData, 5000);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
